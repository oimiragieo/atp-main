
version: "3.8"
services:
  reverse-proxy:
    image: nginx:1.25-alpine
    ports: ["7443:7443", "7444:7444"]
    volumes:
      - ./deploy/docker/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./deploy/docker/ssl:/etc/nginx/ssl:ro
    depends_on: [router]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7443/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - atp-network

  router:
    build:
      context: .
      dockerfile: deploy/docker/Dockerfile.router
    environment:
      - RUST_LOG=info,atp_router=debug
      - ADAPTER_ENDPOINTS=["http://persona_adapter:7070","http://ollama_adapter:7070"]
      - FEATURE_WIRE_MEMORY=true
      - MEMORY_GATEWAY_URL=http://memory-gateway:8080
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - OPA_URL=http://opa:8181
      - ENABLE_BUDGET_PREFLIGHT=1
      - ROUTER_REDIS_URL=redis://redis:6379/0
    # ports: ["7443:7443"]  # Commented out - reverse proxy handles external access
    expose: ["7443"]  # Expose to other containers
    depends_on: [ persona_adapter, ollama_adapter, memory-gateway, otel-collector, opa, redis ]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7443/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - atp-network

  persona_adapter:
    build: ./adapters/python/persona_adapter
    ports: [ "7071:7070" ]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7070/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  ollama_adapter:
    build: ./adapters/python/ollama_adapter
    ports: [ "7072:7070" ]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7070/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  memory-gateway:
    build: ./services/memory-gateway
    ports: [ "8080:8080" ]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  redis:
    image: redis:7.2-alpine
    ports: [ "6379:6379" ]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    volumes:
      - redis_data:/data
    networks:
      - atp-network

  pytest:
    build:
      context: .
      dockerfile: deploy/docker/Dockerfile.pytest
    environment:
      - ROUTER_REDIS_URL=redis://redis:6379/0
      - MEMORY_GATEWAY_URL=http://memory-gateway:8080
      - ADAPTER_ENDPOINTS=["http://persona_adapter:7070","http://ollama_adapter:7070"]
    depends_on:
      redis:
        condition: service_healthy
      memory-gateway:
        condition: service_healthy
      persona_adapter:
        condition: service_healthy
      ollama_adapter:
        condition: service_healthy
    networks:
      - atp-network
    volumes:
      - .:/app
    working_dir: /app
    command: ["pytest", "tests/test_memory_gateway.py", "-v"]

  k6:
    build:
      context: .
      dockerfile: deploy/docker/Dockerfile.k6
    environment:
      - BASE_URL=http://memory-gateway:8080
    depends_on:
      memory-gateway:
        condition: service_healthy
    networks:
      - atp-network
    volumes:
      - ./tools/k6_script.js:/scripts/k6_script.js:ro

  opa:
    image: openpolicyagent/opa:0.63.0
    command: ["run","--server","--addr=0.0.0.0:8181","/policy/policy.rego"]
    volumes: [ "./atp-router/opa:/policy:ro" ]
    ports: [ "8181:8181" ]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8181/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  prometheus:
    image: prom/prometheus:v2.53.0
    volumes:
      - ./observability/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./observability/prometheus/alerts.yml:/etc/prometheus/alerts.yml:ro
    ports: [ "9090:9090" ]
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.102.1
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes: [ "./observability/otel-collector-config.yaml:/etc/otel-collector-config.yaml:ro" ]
    ports: [ "4317:4317", "4318:4318", "8889:8889" ]
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:13133"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  tempo:
    image: grafana/tempo:2.5.0
    command: ["-config.file=/etc/tempo.yaml"]
    volumes: [ "./configs/observability/tempo.yaml:/etc/tempo.yaml:ro" ]
    ports: [ "3200:3200" ]
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3200/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  grafana:
    image: grafana/grafana:11.1.0
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - ./observability/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      - ./observability/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./observability/grafana/provisioning/dashboards/json:/var/lib/grafana/dashboards/json:ro
    ports: [ "3000:3000" ]
    depends_on: [ prometheus, tempo ]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  atp-network:
    driver: bridge

volumes:
  redis_data:
