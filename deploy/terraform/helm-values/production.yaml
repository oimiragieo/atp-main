# ATP Production Helm Values
# Production-grade configuration with high availability and security

global:
  environment: ${environment}
  imageTag: ${image_tag}
  
# Application configuration
app:
  name: atp
  version: "2.0.0"
  
  # Replica configuration for high availability
  replicaCount: ${replicas}
  
  image:
    repository: atp/router-service
    tag: ${image_tag}
    pullPolicy: IfNotPresent
  
  # Resource limits for production workloads
  resources:
    limits:
      cpu: 2000m
      memory: 4Gi
    requests:
      cpu: 1000m
      memory: 2Gi
  
  # Health checks
  livenessProbe:
    httpGet:
      path: /health
      port: 8000
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  
  readinessProbe:
    httpGet:
      path: /ready
      port: 8000
    initialDelaySeconds: 5
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 3
  
  # Environment variables
  env:
    - name: ATP_ENV
      value: ${environment}
    - name: ATP_LOG_LEVEL
      value: "INFO"
    - name: ATP_DATABASE_URL
      value: "postgresql://atp_user:$(DATABASE_PASSWORD)@${database_host}:5432/atp"
    - name: ATP_REDIS_URL
      value: "redis://${redis_host}:6379/0"
    - name: DATABASE_PASSWORD
      valueFrom:
        secretKeyRef:
          name: atp-secrets
          key: database-password
  
  # Security context
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000
    capabilities:
      drop:
        - ALL
    readOnlyRootFilesystem: true
    allowPrivilegeEscalation: false

# Service configuration
service:
  type: ClusterIP
  port: 80
  targetPort: 8000
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
    service.beta.kubernetes.io/aws-load-balancer-backend-protocol: "http"

# Ingress configuration
ingress:
  enabled: true
  className: "nginx"
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
  hosts:
    - host: api.atp.company.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: atp-tls
      hosts:
        - api.atp.company.com

# Horizontal Pod Autoscaler
autoscaling:
  enabled: true
  minReplicas: 3
  maxReplicas: 20
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

# Pod Disruption Budget
podDisruptionBudget:
  enabled: true
  minAvailable: 2

# Network Policy
networkPolicy:
  enabled: true
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx
      ports:
        - protocol: TCP
          port: 8000
    - from:
        - namespaceSelector:
            matchLabels:
              name: atp-monitoring
      ports:
        - protocol: TCP
          port: 8000

# Service Monitor for Prometheus
serviceMonitor:
  enabled: true
  interval: 30s
  path: /metrics
  labels:
    app: atp
    environment: ${environment}

# Pod Security Policy
podSecurityPolicy:
  enabled: true

# Resource Quota
resourceQuota:
  enabled: true
  hard:
    requests.cpu: "10"
    requests.memory: "20Gi"
    limits.cpu: "20"
    limits.memory: "40Gi"
    persistentvolumeclaims: "10"

# Limit Range
limitRange:
  enabled: true
  limits:
    - default:
        cpu: "500m"
        memory: "1Gi"
      defaultRequest:
        cpu: "100m"
        memory: "256Mi"
      type: Container

# Vertical Pod Autoscaler
verticalPodAutoscaler:
  enabled: true
  updateMode: "Auto"
  resourcePolicy:
    containerPolicies:
      - containerName: atp
        maxAllowed:
          cpu: 4000m
          memory: 8Gi
        minAllowed:
          cpu: 100m
          memory: 256Mi

# External Secrets
externalSecrets:
  enabled: true
  secretStore:
    provider: aws
    auth:
      region: us-west-2
      role: arn:aws:iam::123456789012:role/atp-secrets-role
  secrets:
    - name: atp-secrets
      data:
        - secretKey: database-password
          remoteRef:
            key: /atp/${environment}/database/password
        - secretKey: redis-password
          remoteRef:
            key: /atp/${environment}/redis/password
        - secretKey: jwt-secret
          remoteRef:
            key: /atp/${environment}/jwt/secret

# Prometheus Rules
prometheusRules:
  enabled: true
  rules:
    - alert: ATPHighErrorRate
      expr: rate(atp_requests_total{status=~"5.."}[5m]) > 0.1
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "ATP high error rate"
        description: "ATP error rate is above 10% for 5 minutes"
    
    - alert: ATPHighLatency
      expr: histogram_quantile(0.95, rate(atp_request_duration_seconds_bucket[5m])) > 2
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "ATP high latency"
        description: "ATP 95th percentile latency is above 2 seconds"
    
    - alert: ATPPodCrashLooping
      expr: rate(kube_pod_container_status_restarts_total{pod=~"atp-.*"}[15m]) > 0
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "ATP pod crash looping"
        description: "ATP pod {{ $labels.pod }} is crash looping"

# Admin Dashboard (if enabled)
adminDashboard:
  enabled: true
  replicaCount: 2
  image:
    repository: atp/admin-dashboard
    tag: ${image_tag}
  
  resources:
    limits:
      cpu: 500m
      memory: 1Gi
    requests:
      cpu: 250m
      memory: 512Mi
  
  service:
    type: ClusterIP
    port: 80
    targetPort: 3000
  
  ingress:
    enabled: true
    className: "nginx"
    annotations:
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
      cert-manager.io/cluster-issuer: "letsencrypt-prod"
    hosts:
      - host: admin.atp.company.com
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: atp-admin-tls
        hosts:
          - admin.atp.company.com

# Memory Gateway (if enabled)
memoryGateway:
  enabled: true
  replicaCount: 2
  image:
    repository: atp/memory-gateway
    tag: ${image_tag}
  
  resources:
    limits:
      cpu: 1000m
      memory: 2Gi
    requests:
      cpu: 500m
      memory: 1Gi