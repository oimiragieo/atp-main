# Copyright 2025 ATP Project Contributors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

{{- if not .Values.database.external }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.database.credentials.secretName }}
  labels:
    {{- include "atp.labels" . | nindent 4 }}
type: Opaque
data:
  {{ .Values.database.credentials.usernameKey }}: {{ "atp" | b64enc }}
  {{ .Values.database.credentials.passwordKey }}: {{ randAlphaNum 32 | b64enc }}
  database: {{ (.Values.database.credentials.database | default "atp") | b64enc }}
---
{{- end }}

{{- if not .Values.redis.external }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.redis.credentials.secretName }}
  labels:
    {{- include "atp.labels" . | nindent 4 }}
type: Opaque
data:
  {{ .Values.redis.credentials.passwordKey }}: {{ randAlphaNum 32 | b64enc }}
---
{{- end }}

{{- if .Values.externalServices.cloudSqlProxy.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "atp.fullname" . }}-sa-key
  labels:
    {{- include "atp.labels" . | nindent 4 }}
type: Opaque
data:
  service_account.json: {{ .Values.serviceAccount.keyData | b64enc }}
---
{{- end }}

# API Keys and sensitive configuration
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "atp.fullname" . }}-api-keys
  labels:
    {{- include "atp.labels" . | nindent 4 }}
type: Opaque
data:
  openai-api-key: {{ .Values.secrets.openaiApiKey | default "" | b64enc }}
  anthropic-api-key: {{ .Values.secrets.anthropicApiKey | default "" | b64enc }}
  jwt-secret: {{ .Values.secrets.jwtSecret | default (randAlphaNum 64) | b64enc }}
  encryption-key: {{ .Values.secrets.encryptionKey | default (randAlphaNum 32) | b64enc }}