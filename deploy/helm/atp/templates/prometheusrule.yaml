# Copyright 2025 ATP Project Contributors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

{{- if and .Values.monitoring.enabled .Values.monitoring.alerts.enabled }}
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{ include "atp.fullname" . }}
  labels:
    {{- include "atp.labels" . | nindent 4 }}
spec:
  groups:
    - name: atp.rules
      rules:
        {{- range .Values.monitoring.alerts.rules }}
        - alert: {{ .name }}
          expr: {{ .expr }}
          for: {{ .for }}
          labels:
            {{- toYaml .labels | nindent 12 }}
            service: {{ include "atp.fullname" $ }}
          annotations:
            {{- toYaml .annotations | nindent 12 }}
            runbook_url: "https://docs.atp.company.com/runbooks/{{ .name | lower }}"
        {{- end }}
        
        # Additional standard alerts
        - alert: ATPHighMemoryUsage
          expr: |
            (
              container_memory_working_set_bytes{container="router",pod=~"{{ include "atp.fullname" . }}-router-.*"}
              /
              container_spec_memory_limit_bytes{container="router",pod=~"{{ include "atp.fullname" . }}-router-.*"}
            ) > 0.9
          for: 5m
          labels:
            severity: warning
            service: {{ include "atp.fullname" . }}
          annotations:
            summary: "ATP Router high memory usage"
            description: "ATP Router memory usage is above 90% for more than 5 minutes"
            
        - alert: ATPHighCPUUsage
          expr: |
            (
              rate(container_cpu_usage_seconds_total{container="router",pod=~"{{ include "atp.fullname" . }}-router-.*"}[5m])
              /
              container_spec_cpu_quota{container="router",pod=~"{{ include "atp.fullname" . }}-router-.*"} * 100000
            ) > 0.9
          for: 5m
          labels:
            severity: warning
            service: {{ include "atp.fullname" . }}
          annotations:
            summary: "ATP Router high CPU usage"
            description: "ATP Router CPU usage is above 90% for more than 5 minutes"
            
        - alert: ATPPodCrashLooping
          expr: |
            rate(kube_pod_container_status_restarts_total{pod=~"{{ include "atp.fullname" . }}-.*"}[15m]) > 0
          for: 5m
          labels:
            severity: critical
            service: {{ include "atp.fullname" . }}
          annotations:
            summary: "ATP Pod is crash looping"
            description: "ATP Pod {{ "{{ $labels.pod }}" }} is restarting frequently"
            
        - alert: ATPServiceDown
          expr: |
            up{job="{{ include "atp.fullname" . }}"} == 0
          for: 1m
          labels:
            severity: critical
            service: {{ include "atp.fullname" . }}
          annotations:
            summary: "ATP Service is down"
            description: "ATP Service has been down for more than 1 minute"
            
        - alert: ATPDatabaseConnectionFailure
          expr: |
            increase(atp_database_connection_errors_total[5m]) > 5
          for: 2m
          labels:
            severity: critical
            service: {{ include "atp.fullname" . }}
          annotations:
            summary: "ATP Database connection failures"
            description: "ATP is experiencing database connection failures"
            
        - alert: ATPRedisConnectionFailure
          expr: |
            increase(atp_redis_connection_errors_total[5m]) > 5
          for: 2m
          labels:
            severity: warning
            service: {{ include "atp.fullname" . }}
          annotations:
            summary: "ATP Redis connection failures"
            description: "ATP is experiencing Redis connection failures"
{{- end }}